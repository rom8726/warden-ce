# Warden: Self-hosted платформа мониторинга ошибок, совместимая с Sentry

<div align="center">
  <img src="docs/logo_full.png" alt="Warden Logo" height="150"/>
</div>

---

## Краткий обзор

**Warden** - это self-hosted платформа мониторинга ошибок, полностью совместимая с официальными SDK Sentry.
Она позволяет организациям собирать, хранить и анализировать ошибки приложений на собственной инфраструктуре,
с современным веб-интерфейсом и расширенными функциями управления инцидентами.
Warden разработан как прямая замена Sentry: вы можете использовать существующие SDK Sentry без каких-либо изменений в клиентском коде.

---

## Описание

Warden предоставляет надежное, расширяемое и ориентированное на конфиденциальность решение для отслеживания ошибок и оповещений.
Он поддерживает протокол приема данных Sentry, обеспечивая беспрепятственную интеграцию с популярными SDK (`sentry-go`, `@sentry/node`, `sentry-python` и т.д.).
Платформа имеет чистую архитектуру, разработку по принципу API-first и мощный пользовательский интерфейс на основе React для анализа ошибок, командного сотрудничества и управления проектами.

---

## Содержание

1. [О проекте](#о-проекте)
2. [Ключевые особенности](#ключевые-особенности)
3. [Архитектура и компоненты](#архитектура-и-компоненты)
4. [Практики разработки и особенности](#практики-разработки-и-особенности)
5. [Начало работы](#начало-работы)
6. [Установщик](#установщик)
7. [Тестирование](#тестирование)

---

## О проекте

Warden разработан для команд и компаний, которым необходим полный контроль над своим стеком мониторинга ошибок,
конфиденциальность данных и возможность настраивать или расширять платформу.
Он подходит как для небольших команд, так и для крупных предприятий, ищущих совместимое с Sentry решение для локального размещения.

---

## Ключевые особенности

- **Совместимость с SDK Sentry:** Принимает события через конечные точки `/api/:project_id/store/` и `/api/:project_id/envelope/`, используя стандартные DSN Sentry и заголовки аутентификации.
- **Современный веб-интерфейс:** Мощный интерфейс на основе React для анализа ошибок, фильтрации, поиска и командных рабочих процессов.
- **Управление проектами и командами:** RBAC, 2FA, управление пользователями и командами, настройки проекта.
- **Группировка событий и отпечатки:** Продвинутая группировка ошибок и исключений для эффективной сортировки.
- **Уведомления:** Интеграции с Email, Slack, Telegram, Mattermost и Webhooks.
- **Метрики и мониторинг:** Метрики Prometheus, проверки работоспособности и ограничение скорости.
- **API-First:** Спецификация OpenAPI (`specs/server.yml`) является единственным источником истины для API. Код и DTO генерируются из спецификации.
- **Масштабируемое хранилище:**
  - **PostgreSQL:** Метаданные, пользователи, проекты, команды, уведомления.
  - **ClickHouse:** Высокопроизводительное хранилище для событий и трассировок стека (через прием Kafka).
  - **Kafka:** Буферизация и потоковая передача входящих событий.
  - **Redis:** Кэширование и ограничение скорости.
- **Готовность к Docker:** Полная настройка для разработки и производства через Docker Compose и многоэтапный Dockerfile.

## Инструкция по развертыванию

После ознакомления с ключевыми особенностями вы можете развернуть Warden в продакшене с помощью Docker Compose.  
**Выполните следующие шаги:**

1. **Скопируйте production Docker Compose файл:**

   Используйте `docker-compose.yml` из директории `prod`.

2. **Подготовьте конфигурационные файлы:**

   Создайте следующие файлы в `/opt/warden` (должны принадлежать пользователю `root`):

   - `/opt/warden/platform.env` — настройки платформы
   - `/opt/warden/config.env` — конфиг приложения

3. **Заполните `platform.env`:**

   ```
   DOMAIN=warden.your-company.tech         # Домен, на котором будет работать платформа
   DB_PASSWORD=your_postgres_password      # Пароль от PostgreSQL
   CLICKHOUSE_DB_PASSWORD=your_ch_password # Пароль от ClickHouse
   SSL_CERT=warden.crt                     # Имя файла SSL-сертификата (должен лежать в /opt/warden/nginx/ssl)
   SSL_CERT_KEY=warden.key                 # Имя файла SSL-ключа (должен лежать в /opt/warden/nginx/ssl)
   PLATFORM_VERSION=latest                 # Версия платформы (например, v1.2.3 или latest)
   ```

4. **Заполните `config.env`:**

   ```
   WARDEN_FRONTEND_URL=https://warden.your-company.tech   # URL для писем и редиректов
   WARDEN_SECRET_KEY=your_very_secret_key                # 16 или 32 символа
   WARDEN_JWT_SECRET_KEY=your_jwt_secret_key             # 16 или 32 символа
   WARDEN_POSTGRES_PASSWORD=your_postgres_password       # Совпадает с DB_PASSWORD из platform.env
   WARDEN_CLICKHOUSE_PASSWORD=your_ch_password           # Совпадает с CLICKHOUSE_DB_PASSWORD из platform.env
   WARDEN_MAILER_ADDR=smtp.yandex.ru:465                 # Адрес SMTP сервера
   WARDEN_MAILER_USER=mailer_user                        # SMTP пользователь
   WARDEN_MAILER_PASSWORD=mailer_password                # Пароль от SMTP
   WARDEN_MAILER_FROM=warden@your-company.tech           # Email отправителя
   WARDEN_MAILER_USE_TLS=true                            # Использовать TLS (true/false)
   WARDEN_MAILER_CERT_FILE=                              # (опционально) путь к TLS сертификату
   WARDEN_MAILER_KEY_FILE=                               # (опционально) путь к TLS ключу
   WARDEN_MAILER_ALLOW_INSECURE=false                    # Игнорировать проверку сертификата (для самоподписных)
   WARDEN_ADMIN_EMAIL=admin@your-company.tech            # Email администратора платформы
   WARDEN_ADMIN_TMP_PASSWORD=your_admin_temp_password    # Временный пароль администратора
   ```

5. **Положите SSL-сертификаты:**

   Поместите SSL-сертификат и ключ в `/opt/warden/nginx/ssl` с именами, указанными в `platform.env`.

6. **Запустите платформу:**

   ```bash
   cd /opt/warden
   docker compose --env-file platform.env up -d
   ```

---

## Архитектура и компоненты

Warden следует строгой **Многослойной чистой архитектуре**:

- **Слой домена (`internal/domain`):** Основные бизнес-сущности (например, User, Project, Issue) без зависимостей от фреймворков или хранилища.
- **Слой контрактов (`internal/contract`):** Интерфейсы (контракты) для репозиториев и сервисов, обеспечивающие инверсию зависимостей.
- **Слой вариантов использования (`internal/usecases`):** Бизнес-логика, оркестрирующая сущности домена и репозитории через интерфейсы.
- **Слой репозитория (`internal/repository`):** Реализации доступа к данным, отображение между моделями хранения и сущностями домена.
- **Слой API (`internal/api/rest`):** HTTP-обработчики, валидация запросов, преобразование DTO и кодогенерация на основе OpenAPI.
- **Слой сервисов (`internal/services`):** Интеграции с внешними системами (email, мессенджеры и т.д.).

**Правило зависимостей:** Зависимости всегда направлены внутрь; внешние слои зависят от интерфейсов внутренних слоев, но никогда наоборот.

**Управление транзакциями:** Операции с несколькими репозиториями обернуты в транзакции с использованием менеджера транзакций (`pkg/db/TxManager`).

**Внедрение зависимостей:** Все компоненты инициализируются через DI-контейнер ([rom8726/di](https://github.com/rom8726/di)).

---

## Практики разработки и особенности

- **Строгие границы слоев:**
  - Слой API вызывает только варианты использования
  - Варианты использования зависят только от интерфейсов из `internal/contract`
  - Репозитории реализуют только интерфейсы, никогда не раскрывают детали хранения бизнес-логике
- **Инверсия зависимостей:** Все зависимости внедряются через интерфейсы, а не конкретные типы.
- **Доменно-ориентированный подход:** Сущности домена - это чистые структуры Go, свободные от тегов хранения или фреймворка.
- **API-First:** Все изменения API начинаются со спецификации OpenAPI (`specs/server.yml`). DTO и обработчики генерируются и отображаются на модели домена в `internal/dto`.
- **Тестирование:**
  - **Модульные тесты:** Используют моки (сгенерированные через `mockery`, хранятся в `test_mocks/`)
  - **Функциональные тесты:** Используют [testy](https://github.com/rom8726/testy) — декларативные YAML-сценарии в `tests/cases/`, с фикстурами в `tests/fixtures/`. Testy запускает приложение, загружает фикстуры, выполняет HTTP-запросы и проверяет состояние БД.
  - **Интеграционные тесты:** Запускаются с помощью `go test -tags=integration ./tests/...`
- **Линтинг и форматирование:**
  - `golangci-lint` со строгими правилами (см. `.golangci.yml`)
  - Максимальная длина строки: 120 символов
  - Автоматическое форматирование через `gofmt` и `gofumpt`
- **Среда разработки:**
  - `make dev-up` — запуск полного стека разработки (Postgres, ClickHouse, Kafka, Redis и т.д.)
  - `make dev-down`, `make dev-clean`, `make dev-logs` для управления
  - Переменные окружения в `dev/config.env.example`
- **Управление миграциями:**
  - Миграции PostgreSQL и ClickHouse в `migrations/`
  - Запускаются автоматически при старте

---

## Начало работы

### Настройка среды разработки

1. **Клонировать репозиторий:**
   ```bash
   git clone https://github.com/rom8726/warden.git
   cd warden
   ```
2. **Запустить среду разработки:**
   ```bash
   make dev-up
   ```
3. **Сгенерировать серверный код из спецификации OpenAPI:**
   ```bash
   make generate-backend
   ```
4. **Доступ к пользовательскому интерфейсу:**
   - Откройте [http://localhost:3000](http://localhost:3000) в вашем браузере
5. **Просмотр логов:**
   ```bash
   make dev-logs
   ```

---

## Тестирование

Warden использует собственный фреймворк [testy](https://github.com/rom8726/testy) для функционального тестирования API.

### Функциональное тестирование

**testy** — это декларативный фреймворк для тестирования HTTP API, который позволяет:

- Писать тесты в YAML-формате с описанием сценариев
- Запускать тесты через `http.Handler` с возможностью отладки (breakpoints)
- Работать с PostgreSQL-фикстурами через [pgfixtures](https://github.com/rom8726/pgfixtures)
- Проверять JSON-ответы, SQL-запросы и моки внешних сервисов
- Использовать шаблоны, переменные и цепочки шагов

### Запуск тестов

```bash
# Модульные тесты
make test

# Функциональные тесты
make test.integration
```

---

## Структура DSN и протокол

### Формат DSN

DSN (Data Source Name) используется SDK для настройки подключения к серверу. Он включает:

```
https://<public_key>@<host>/<project_id>
```

Пример:

```
https://abc123@warden.local/42
```

### Авторизация

SDK Sentry использует один из следующих заголовков:

#### `X-Sentry-Auth` (предпочтительно)

```
X-Sentry-Auth: Sentry sentry_key=abc123, sentry_version=7, sentry_client=sentry.go/0.13.0
```

#### Или `Authorization: Sentry ...`

```
Authorization: Sentry sentry_key=abc123, sentry_version=7
```

---

## API: Прием событий

### `POST /api/:project_id/store/`

#### Назначение

Прием событий об ошибках и исключениях, отправленных с использованием официальных SDK Sentry.

#### Параметры

| Параметр     | Тип          | Обязательный | Описание                                         |
| ------------ | ------------ | ------------ | ------------------------------------------------ |
| `project_id` | path param   | ✅            | Идентификатор проекта, соответствует `project_id` из DSN |

#### Заголовки

* `X-Sentry-Auth` или `Authorization: Sentry ...`

#### Тело запроса

JSON-формат, соответствующий [Sentry Event Payload](https://develop.sentry.dev/sdk/event-payloads/).

Пример:

```json
{
  "event_id": "8e4f5d83f65b4173b0e4036a64042fda",
  "timestamp": "2025-06-04T17:00:00Z",
  "level": "error",
  "platform": "go",
  "message": "Unhandled panic: index out of range",
  "exception": {
    "values": [{
      "type": "panic",
      "value": "index out of range",
      "stacktrace": {
        "frames": []
      }
    }]
  },
  "user": {
    "id": "123"
  },
  "tags": {
    "env": "prod"
  }
}
```

#### Ответы

| Код                | Значение                              |
| ------------------ | ------------------------------------- |
| `200 OK`           | Событие принято                       |
| `400 Bad Request`  | Неверный формат события               |
| `401 Unauthorized` | Неверный или отсутствующий ключ       |
| `404 Not Found`    | Проект не найден                      |

---

## Архитектура проекта

Проект построен на принципах **Чистой архитектуры** с четким разделением на слои:

### Слои архитектуры

1. **Слой домена** (`internal/domain`)
   - Содержит основные бизнес-модели: `Event`, `Exception`, `Project`
   - Не зависит от других слоев или внешних фреймворков

2. **Слой бизнес-логики** (`internal/usecases`)
   - Реализует бизнес-логику приложения
   - Взаимодействует с репозиториями через интерфейсы
   - Разделен по функциональным областям: `events`, `exceptions`, `projects`

3. **Слой репозитория** (`internal/repository`)
   - Отвечает за доступ к данным и хранение
   - Реализует интерфейсы, определенные в слое бизнес-логики
   - Разделен по типам сущностей: `events`, `exceptions`, `projects`

4. **Слой API** (`internal/api/rest`)
   - Реализует HTTP API для взаимодействия с клиентами
   - Использует сгенерированные интерфейсы из спецификации OpenAPI
   - Преобразует HTTP-запросы в вызовы бизнес-логики

### Компоненты системы

| Компонент           | Назначение |
|---------------------|------------|
| **PostgreSQL**      | Хранение информации о проектах и известных отпечатках |
| **ClickHouse**      | Хранение событий и исключений с TTL и партиционированием |
| **Kafka**           | Брокер сообщений между API и ClickHouse |
| **Redis**           | Кэш для проверки дубликатов и ограничения скорости |
| **API Server**      | Обработка входящих событий, генерация отпечатков, отправка в Kafka |

### Поток данных

```
Sentry SDK → [HTTP POST] → API Server → [Преобразует + генерирует отпечаток] → [Записывает в Kafka] → ClickHouse Kafka Engine → Materialized View → Таблицы ClickHouse
```

---

## Запуск и развертывание

### Локальное развертывание

Для локальной разработки и тестирования используйте Docker Compose:

1. Клонировать репозиторий:
   ```bash
   git clone https://github.com/rom8726/warden.git
   cd warden
   ```

2. Создать файл конфигурации окружения:
   ```bash
   cp dev/compose.env.example dev/compose.env
   cp dev/config.env.example dev/config.env
   ```

3. Запустить сервисы с помощью Docker Compose:
   ```bash
   make dev-up
   ```

4. Проверить, что все сервисы запущены:
   ```bash
   docker ps
   ```

5. Для остановки сервисов:
   ```bash
   make dev-down
   ```

### Сборка и запуск

Для сборки приложения:

```bash
make build
```

Для запуска сервера:

```bash
./bin/app server --env-file=./config.env
```

### Миграции

Миграции запускаются автоматически при запуске сервера. Для ручного выполнения миграций:

```bash
./bin/app migrate --env-file=./config.env
```

## Мониторинг и метрики

Приложение предоставляет метрики Prometheus на конечной точке `/metrics` технического сервера (порт по умолчанию 8081).

Основные метрики:

- `warden_events_received_total` - количество полученных событий
- `warden_events_processed_total` - количество обработанных событий
- `warden_exceptions_received_total` - количество полученных исключений
- `warden_exceptions_processed_total` - количество обработанных исключений
- `warden_validation_errors_total` - количество ошибок валидации
- `warden_processing_time_seconds` - время обработки событий и исключений
- `warden_kafka_messages_produced_total` - количество сообщений, отправленных в Kafka
- `warden_kafka_messages_consumed_total` - количество сообщений, полученных из Kafka

## Разработка

### Структура проекта

```
warden/
├── cmd/                  # Точки входа приложения
├── dev/                  # Файлы для локальной разработки
├── internal/             # Внутренний код приложения
│   ├── backend/          # Код бэкенда
│   │   ├── api/          # Слой API
│   │   ├── contract/     # Интерфейсы (контракты)
│   │   ├── dto/          # Объекты передачи данных
│   │   └── usecases/     # Бизнес-логика
│   ├── context/          # Утилиты контекста
│   ├── domain/           # Модели домена
│   └── repository/       # Репозитории для доступа к данным
├── migrations/           # Миграции базы данных
│   ├── clickhouse/       # Миграции для ClickHouse
│   └── postgresql/       # Миграции для PostgreSQL
├── pkg/                  # Многоразовые пакеты
│   ├── db/               # Утилиты базы данных
│   ├── httpserver/       # HTTP-сервер
│   ├── kafka/            # Утилиты Kafka
│   └── metrics/          # Метрики Prometheus
├── specs/                # Спецификации OpenAPI
├── test_mocks/           # Сгенерированные моки для тестирования
└── tests/                # Тесты
```

### Генерация кода

Серверный код генерируется из спецификации OpenAPI с использованием ogen:

```bash
make generate
```

### Линтинг

Для проверки кода используется golangci-lint:

```bash
make lint
```

---

## Ссылки и ресурсы

* [Sentry Event Payloads](https://develop.sentry.dev/sdk/event-payloads/)
* [Sentry Envelope Format](https://develop.sentry.dev/sdk/envelopes/)

---

## API Specification First

Проект использует подход **API Specification First**. Это означает, что:

* Описание всех конечных точек поддерживается в **документе OpenAPI YAML** (`specs/server.yml`)
* Этот документ является **единственным источником истины** для генерации моделей, валидации, автодокументации и клиента
* Серверный код генерируется с использованием [ogen](https://github.com/ogen-go/ogen)

Основные конечные точки:

1. `POST /api/{project_id}/store/` - для приема событий в формате JSON
2. `POST /api/{project_id}/envelope/` - для приема событий в формате Envelope

---

## Расчет отпечатка

Отпечаток используется для группировки событий и исключений:

### Отпечаток для события
- Для событий: хеш сообщения + уровень + платформа

### Отпечаток для исключения
- Для исключений: хеш типа исключения, значения исключения, трассировки стека

Для расчета отпечатка используется SHA1.

---
